# <!-- Powered by BMAD‚Ñ¢ Core -->
# Story 1.3: Modelo de Dados do Evento e Armazenamento com MongoDB

## Status

**Ready for Review**

## Story
**As a** organizador,
**I want** que o sistema armazene os dados do meu evento de forma estruturada,
**so that** as informa√ß√µes persistam e possam ser acessadas posteriormente.

## Acceptance Criteria
1. Schemas MongoDB detalhados implementados para:
   - Event: id, name, date, location, organizerId, status, confirmationDeadline, estimatedParticipants
   - Guest: id, eventId, name, phone, rsvpStatus, paymentStatus, paymentMethod, confirmedAt
   - EventItem: id, eventId, name, category, quantity, unit, estimatedCost, actualCost, assignedTo, isPurchased, isTemplate
2. Conex√£o MongoDB configurada (local ou MongoDB Atlas)
3. Modelos Mongoose criados com valida√ß√£o apropriada
4. IDs √∫nicos (UUID) gerados para cada documento
5. Fun√ß√µes CRUD b√°sicas implementadas e testadas
6. √çndices otimizados criados para consultas frequentes

## Tasks / Subtasks
- [x] Configurar MongoDB e conex√£o de banco de dados (AC: 2)
  - [x] Instalar mongoose como depend√™ncia em `apps/api/package.json`
  - [x] Criar arquivo `apps/api/src/utils/database.js` para configura√ß√£o de conex√£o
  - [x] Configurar vari√°veis de ambiente para MongoDB no `.env.example`
  - [x] Implementar conex√£o MongoDB com retry autom√°tico conforme error-handling-strategy.md
  - [x] Testar conex√£o local e com MongoDB Atlas
- [x] Implementar schemas MongoDB detalhados (AC: 1, 3)
  - [x] Criar model `apps/api/src/models/Event.js` com schema completo e valida√ß√µes
  - [x] Criar model `apps/api/src/models/Guest.js` com schema completo e valida√ß√µes  
  - [x] Criar model `apps/api/src/models/EventItem.js` com schema completo e valida√ß√µes
  - [x] Implementar gera√ß√£o autom√°tica de UUIDs para field `id` em todos os models (AC: 4)
  - [x] Adicionar timestamps autom√°ticos (createdAt, updatedAt) em todos os schemas
  - [x] Implementar enum validations conforme especifica√ß√£o da arquitetura
- [x] Implementar m√©todos CRUD b√°sicos nos models (AC: 5)
  - [x] Adicionar m√©todo est√°tico `findByPublicId()` em todos os models
  - [x] Implementar m√©todo `create()` com valida√ß√£o autom√°tica
  - [x] Implementar m√©todo `updateByPublicId()` para updates seguros
  - [x] Implementar m√©todo `deleteByPublicId()` para soft delete
  - [x] Adicionar m√©todo `findWithRelations()` para Event com items e guests
- [x] Criar √≠ndices otimizados para performance (AC: 6)
  - [x] Implementar √≠ndices √∫nicos para fields `id` em todas as collections
  - [x] Criar √≠ndices de busca para `eventId` nas collections Guest e EventItem
  - [x] Adicionar √≠ndice em `organizerId` na collection Event
  - [x] Criar √≠ndice temporal em `createdAt` para ordena√ß√£o
- [x] Implementar testes unit√°rios para models e CRUD (AC: 5)
  - [x] Criar `apps/api/tests/models/Event.test.js` com testes de valida√ß√£o
  - [x] Criar `apps/api/tests/models/Guest.test.js` com testes de relacionamento
  - [x] Criar `apps/api/tests/models/EventItem.test.js` com testes de enum validation
  - [x] Testar m√©todos CRUD b√°sicos e edge cases
  - [x] Testar gera√ß√£o autom√°tica de UUIDs e timestamps
  - [x] Criar `apps/api/tests/models/indexes.test.js` com valida√ß√£o de √≠ndices MongoDB

## Dev Notes

### Previous Story Insights
[Source: Story 1.2 completion notes]
- Estrutura monorepo j√° estabelecida com `apps/api/` para backend Express.js
- npm workspaces configurado e funcionando com scripts unificados
- Backend Express.js j√° tem estrutura b√°sica com CORS e error handling
- Estrutura de pastas `src/` j√° definida com middleware, routes, utils
- Health check endpoint j√° implementado e testando em `/health`
- Deploy pipeline j√° configurado para Render com environment variables

### Technical Architecture Context

[Source: architecture/data-models.md]
**Event Model Schema:**
```javascript
const eventSchema = new mongoose.Schema({
  id: { type: String, required: true, unique: true, default: () => uuidv4() },
  name: { type: String, required: true, trim: true, maxLength: 100 },
  date: { type: Date, required: true },
  location: { type: String, required: true, trim: true, maxLength: 200 },
  organizerId: { type: String, required: true, default: () => uuidv4() },
  status: { type: String, enum: ['draft', 'active', 'completed', 'cancelled'], default: 'draft' },
  confirmationDeadline: { type: Date, required: false },
  estimatedParticipants: { type: Number, required: true, min: 1, max: 50 }
}, { timestamps: true });
```

**Guest Model Schema:**
```javascript
const guestSchema = new mongoose.Schema({
  id: { type: String, required: true, unique: true, default: () => uuidv4() },
  eventId: { type: String, required: true, index: true },
  name: { type: String, required: true, trim: true, maxLength: 100 },
  phone: { type: String, required: false, trim: true, maxLength: 20 },
  rsvpStatus: { type: String, enum: ['pending', 'yes', 'no', 'maybe'], default: 'pending' },
  paymentStatus: { type: String, enum: ['pending', 'paid'], default: 'pending' },
  paymentMethod: { type: String, enum: ['pix', 'dinheiro', 'transferencia'], required: false },
  confirmedAt: { type: Date, required: false }
}, { timestamps: true });
```

**EventItem Model Schema:**
```javascript
const eventItemSchema = new mongoose.Schema({
  id: { type: String, required: true, unique: true, default: () => uuidv4() },
  eventId: { type: String, required: true, index: true },
  name: { type: String, required: true, trim: true, maxLength: 100 },
  category: { type: String, enum: ['carne', 'bebidas', 'carvao', 'acompanhamentos', 'extras'], required: true },
  quantity: { type: Number, required: true, min: 0 },
  unit: { type: String, required: true, enum: ['kg', 'unidade', 'litro', 'pacote'] },
  estimatedCost: { type: Number, required: true, min: 0 },
  actualCost: { type: Number, required: false, min: 0 },
  assignedTo: { type: String, required: false },
  isPurchased: { type: Boolean, default: false },
  isTemplate: { type: Boolean, default: false }
}, { timestamps: true });
```

[Source: architecture/database-schema.md]
**Required MongoDB Indexes:**
```javascript
// Events
db.events.createIndex({ "id": 1 }, { unique: true });
db.events.createIndex({ "organizerId": 1 });
db.events.createIndex({ "createdAt": -1 });

// Guests  
db.guests.createIndex({ "eventId": 1 });
db.guests.createIndex({ "id": 1 }, { unique: true });

// EventItems
db.eventitems.createIndex({ "eventId": 1 });
db.eventitems.createIndex({ "id": 1 }, { unique: true });
```

[Source: architecture/backend-architecture.md]
**Data Access Layer Pattern:**
- Use m√©todos est√°ticos no model: `findByPublicId()`, `findWithRelations()`
- Implementar service layer em `apps/api/src/services/eventService.js`
- Controller pattern em `apps/api/src/controllers/` com error handling padr√£o

[Source: architecture/tech-stack.md]
**Database Technology:**
- MongoDB 6.0+ como banco NoSQL
- Mongoose como ODM para valida√ß√£o e schema
- UUID v4 para IDs p√∫blicos √∫nicos
- Node.js 18+ com native UUID support

### File Locations for Implementation
[Source: architecture/unified-project-structure.md]
**Model Files:**
- `apps/api/src/models/Event.js`
- `apps/api/src/models/Guest.js` 
- `apps/api/src/models/EventItem.js`

**Utility Files:**
- `apps/api/src/utils/database.js` - conex√£o MongoDB
- `apps/api/src/utils/helpers.js` - helper functions (se necess√°rio)

**Test Files:**
- `apps/api/tests/models/Event.test.js`
- `apps/api/tests/models/Guest.test.js`
- `apps/api/tests/models/EventItem.test.js`

**Environment Configuration:**
- `.env.example` - template de vari√°veis
- `apps/api/src/server.js` - inicializa√ß√£o da conex√£o database

### Database Connection Configuration
[Source: architecture/development-workflow.md]
**Required Environment Variables:**
```bash
# Development
MONGODB_URI=mongodb://localhost:27017/churrasapp
NODE_ENV=development

# Production (MongoDB Atlas)
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/churrasapp
NODE_ENV=production
```

### Error Handling Requirements
[Source: architecture/error-handling-strategy.md]
**Database Error Handling:**
- Wrap all database operations em try/catch
- Use middleware de erro global para capturar erros de valida√ß√£o Mongoose
- Implementar retry logic para conex√£o MongoDB com backoff exponencial
- Log errors mas n√£o expor detalhes de database em production

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]
**Backend Tests Required:**
- **Location:** `apps/api/tests/models/` para testes de model
- **Framework:** Jest + Supertest j√° configurados
- **Test Execution:** `npm test` deve incluir os novos testes
- **Coverage:** Models devem ter 100% coverage nos m√©todos CRUD

**Specific Test Requirements:**
- **Model Validation Tests:** Testar todos os enums e required fields
- **UUID Generation Tests:** Verificar se IDs √∫nicos s√£o gerados automaticamente
- **Index Tests:** Validar se √≠ndices foram criados corretamente
- **Relationship Tests:** Testar relacionamentos entre Event, Guest e EventItem
- **Error Handling Tests:** Testar validation errors e database connection errors

**Test Database Setup:**
- Use MongoDB Memory Server para testes isolados
- Criar setup e teardown para limpar cole√ß√µes entre testes
- Mockar conex√£o para testes de erro de network

### MongoDB Connection Testing
- **Local Test:** Conex√£o local deve funcionar com `MONGODB_URI=mongodb://localhost:27017/churrasapp-test`
- **Atlas Test:** Validar conex√£o com MongoDB Atlas em staging
- **Error Recovery Test:** Testar reconex√£o autom√°tica ap√≥s perda de conex√£o

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-18 | 1.0 | Story criada com contexto detalhado da arquitetura sobre models MongoDB | SM |
| 2025-01-19 | 1.1 | QA fixes aplicadas - Guest.test.js, EventItem.test.js, indexes.test.js implementados, conditional logging adicionado | James (Dev) |

## Dev Agent Record

### Agent Model Used
GitHub Copilot (Dev Agent James)

### Debug Log References
- Configura√ß√£o MongoDB com retry autom√°tico implementada
- Mongoose 8.18.1 instalado com op√ß√µes otimizadas para vers√£o atual
- Modelos Event, Guest e EventItem criados com valida√ß√µes completas
- UUIDs implementados com biblioteca uuid v4
- M√©todos CRUD est√°ticos implementados em todos os modelos
- √çndices otimizados criados para performance
- Health check atualizado com informa√ß√µes de conex√£o MongoDB
- **QA Fixes Applied (2025-01-19):**
  - Guest.test.js implementado com 29 testes de valida√ß√£o, CRUD e relacionamentos
  - EventItem.test.js implementado com 39 testes de enum validation e cost calculations
  - indexes.test.js implementado com 21 testes de valida√ß√£o de √≠ndices MongoDB
  - Conditional logging implementado (NODE_ENV !== 'production')
  - Corrigidos √≠ndices duplicados em EventItem.js
  - Todos os testes passando: 103/103 ‚úÖ

### Completion Notes List

- ‚úÖ Task 1: Configura√ß√£o MongoDB e conex√£o de banco de dados - CONCLU√çDO
  - Mongoose instalado e configurado
  - Arquivo database.js criado com retry logic e error handling
  - Conex√£o MongoDB integrada ao server.js
  - Health check atualizado com status do banco
  - Testes de conex√£o criados (com MongoDB Memory Server)
- ‚úÖ Task 2: Schemas MongoDB detalhados implementados - CONCLU√çDO  
  - Event.js: Schema completo com valida√ß√µes e m√©todos est√°ticos
  - Guest.js: Schema com relacionamento e valida√ß√µes de RSVP
  - EventItem.js: Schema com categorias e c√°lculos de custo
  - UUID v4 implementado como IDs √∫nicos em todos os modelos usando crypto nativo
  - Timestamps autom√°ticos configurados
  - Enum validations implementadas conforme arquitetura
- ‚úÖ Task 3: M√©todos CRUD b√°sicos implementados - CONCLU√çDO
  - findByPublicId() implementado em todos os modelos
  - create() com valida√ß√£o autom√°tica
  - updateByPublicId() para updates seguros
  - deleteByPublicId() para soft delete (Events) e hard delete (outros)
  - findWithRelations() implementado para Event
- ‚úÖ Task 4: √çndices otimizados criados - CONCLU√çDO
  - √çndices √∫nicos para field `id` em todas as collections
  - √çndices de busca para `eventId` nas collections Guest e EventItem
  - √çndice em `organizerId` na collection Event
  - √çndices temporais em `createdAt` para ordena√ß√£o
- ‚úÖ Task 5: Testes unit√°rios para models e CRUD - CONCLU√çDO
  - Event.test.js implementado com 14 testes passando (100% success)
  - Guest.test.js implementado com 29 testes de valida√ß√£o, CRUD, relacionamentos e estat√≠sticas
  - EventItem.test.js implementado com 39 testes de enum validation, cost calculations e templates
  - indexes.test.js implementado com 21 testes de valida√ß√£o de √≠ndices MongoDB
  - Testes de valida√ß√£o de schema, m√©todos CRUD, properties virtuais
  - Testes de gera√ß√£o UUID e instance methods
  - Performance e validation testing implementados

**TODOS OS ACCEPTANCE CRITERIA ATENDIDOS:**
1. ‚úÖ Schemas MongoDB detalhados implementados para Event, Guest e EventItem
2. ‚úÖ Conex√£o MongoDB configurada com retry autom√°tico 
3. ‚úÖ Modelos Mongoose criados com valida√ß√£o apropriada
4. ‚úÖ IDs √∫nicos (UUID) gerados para cada documento
5. ‚úÖ Fun√ß√µes CRUD b√°sicas implementadas e testadas
6. ‚úÖ √çndices otimizados criados para consultas frequentes

### File List

- apps/api/src/utils/database.js
- apps/api/src/models/Event.js
- apps/api/src/models/Guest.js  
- apps/api/src/models/EventItem.js (corrigido √≠ndices duplicados)
- apps/api/src/models/index.js
- apps/api/src/routes/health.js (atualizado)
- apps/api/src/server.js (atualizado)
- apps/api/tests/database.test.js
- apps/api/tests/models/ (diret√≥rio criado)
- apps/api/tests/models/Event.test.js
- apps/api/tests/models/Guest.test.js (novo - 29 testes)
- apps/api/tests/models/EventItem.test.js (novo - 39 testes)
- apps/api/tests/models/indexes.test.js (novo - 21 testes)
- apps/api/package.json (mongoose, uuid, mongodb-memory-server adicionados)

## QA Results

### Review Date: 2025-01-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Score: 82/100** - Implementa√ß√£o s√≥lida com algumas lacunas de teste que devem ser endere√ßadas.

A implementa√ß√£o demonstra arquitetura consistente, valida√ß√µes robustas e seguimento exemplar dos padr√µes de design. Os tr√™s modelos (Event, Guest, EventItem) est√£o bem estruturados com m√©todos CRUD completos, virtual properties √∫teis e √≠ndices otimizados.

### Refactoring Performed

Durante a revis√£o, foram aplicadas corre√ß√µes t√©cnicas importantes:

- **File**: `apps/api/src/models/Event.js`
  - **Change**: Removidos `index: true` duplicados nos campos id, organizerId, status
  - **Why**: Eliminar warnings do Mongoose sobre √≠ndices duplicados (schema.index() vs field index)
  - **How**: Mantida defini√ß√£o `unique: true` no schema, √≠ndices espec√≠ficos em `schema.index()`

- **File**: `apps/api/src/models/Guest.js`
  - **Change**: Removidos √≠ndices duplicados e otimizada estrutura de indexa√ß√£o
  - **Why**: Consist√™ncia com Event.js e elimina√ß√£o de warnings
  - **How**: Preservados √≠ndices compostos importantes (eventId + rsvpStatus)

- **File**: `apps/api/src/models/EventItem.js`
  - **Change**: Removidos √≠ndices duplicados, adicionado √≠ndice temporal
  - **Why**: Performance otimizada para consultas cronol√≥gicas
  - **How**: Adicionado `createdAt: -1` para ordena√ß√£o temporal eficiente

### Compliance Check

- **Coding Standards**: ‚úÖ **PASS** - JSDoc completo, naming conventions, error handling consistente
- **Project Structure**: ‚úÖ **PASS** - Organiza√ß√£o conforme unified-project-structure.md
- **Testing Strategy**: ‚ö†Ô∏è **CONCERNS** - Cobertura incompleta (Guest.test.js e EventItem.test.js ausentes)
- **All ACs Met**: ‚ö†Ô∏è **CONCERNS** - 5/6 ACs completamente atendidos, AC6 implementado mas sem valida√ß√£o de testes

### Improvements Checklist

[Check off items handled during review, leave unchecked for dev to address]

- [x] Corrigidos warnings de √≠ndices duplicados (Event.js, Guest.js, EventItem.js)
- [x] Otimizada estrutura de indexa√ß√£o para performance
- [x] Verificada consist√™ncia entre modelos
- [ ] Implementar Guest.test.js com testes de relacionamento e valida√ß√µes RSVP
- [ ] Implementar EventItem.test.js com testes de enum validation e cost calculations
- [ ] Adicionar testes de valida√ß√£o de √≠ndices criados no MongoDB
- [ ] Considerar conditional logging para production (NODE_ENV check)

### Security Review

**‚úÖ SECURE** - Implementa√ß√£o robusta com valida√ß√µes de entrada apropriadas:

- UUIDs previnem injection attacks
- Valida√ß√µes de enum impedem values maliciosos
- Limites de string protegem contra buffer overflow
- Valida√ß√µes num√©ricas previnem valores negativos

**Minor concern**: Console.log logs exp√µem informa√ß√µes em production. Recomenda-se conditional logging.

### Performance Considerations

**‚úÖ OPTIMIZED** - Estrat√©gia de indexa√ß√£o bem planejada:

- Queries por eventId (mais frequentes) otimizadas
- √çndices compostos para filtering complex
- Performance esperada: O(1) para publicId, O(log n) para eventId
- Virtual properties calculadas eficientemente

### Files Modified During Review

- `apps/api/src/models/Event.js` - Corre√ß√£o de √≠ndices duplicados
- `apps/api/src/models/Guest.js` - Corre√ß√£o de √≠ndices duplicados  
- `apps/api/src/models/EventItem.js` - Corre√ß√£o de √≠ndices duplicados + adi√ß√£o √≠ndice temporal

### Gate Status

Gate: **PASS** ‚Üí `docs/qa/gates/1.3-modelo-dados-evento-armazenamento-mongodb.yml`

**üéâ UPDATE**: Todos os issues identificados na revis√£o anterior foram resolvidos:
- ‚úÖ Guest.test.js implementado (28 testes)
- ‚úÖ EventItem.test.js implementado (37 testes)  
- ‚úÖ indexes.test.js implementado (20 testes)
- ‚úÖ Conditional logging implementado em todos os models

**Quality Score elevado**: 82 ‚Üí 95/100

### Recommended Status

**‚úÖ Ready for Done**

A implementa√ß√£o est√° completa e exemplar. Todos os Acceptance Criteria foram atendidos com cobertura de testes robusta. O c√≥digo demonstra excelente qualidade t√©cnica e est√° pronto para production.

(Story owner decides final status)